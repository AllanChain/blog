name: Build and Deploy to gh-pages

on:
  push:
    branches:
      - gridsome
  issues:
    types: [opened, edited]

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    if: > 
      (contains(github.event.issue.labels.*.name, '@post') &&
      github.event.sender.login == 'AllanChain') ||
      github.event.pusher.name == 'AllanChain'
    steps:
    - uses: actions/checkout@master
    - name: Use Node.js
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'
    - uses: actions/cache@v2
      id: cache
      with:
        path: node_modules
        key: node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          node-
    - name: Install Packages
      run: npm install
    - name: Build App
      run: npm run build
    - name: Determine Commit message
      id: msg
      shell: node {0}
      run: |
        if (process.env.IS_PUSH === 'true') {
          console.log('::set-output name=msg::' +
            `${process.env.COMMIT_MSG.split('\n', 1)[0]}` +
            ` (${process.env.GITHUB_SHA.slice(0, 7)})`
          )
        } else {
          console.log('::set-output name=msg::Deploy Post ' +
            `"${process.env.TITLE}" (#${process.env.NUMBER})`
          )
        }
      env:
        IS_PUSH: ${{ github.event.pusher.name == 'AllanChain' }}
        COMMIT_MSG: ${{ github.event.head_commit.message }}
        TITLE: ${{ github.event.issue.title }}
        NUMBER: ${{ github.event.issue.number }}
    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./blog
        publish_branch: gh-pages
        full_commit_message: ${{ steps.msg.outputs.msg }}
